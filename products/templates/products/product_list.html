{% extends 'base.html' %}
{% load static %}
{% block content %}
<h1 class="mb-4">–°–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç—ñ–≤</h1>

<!-- –§—ñ–ª—å—Ç—Ä–∏ -->
<form method="get" id="searchForm" class="mb-3">
  <div class="row">
    <div class="col-md-4">
      <input type="text" name="q" class="form-control" placeholder="–ü–æ—à—É–∫ –ø—Ä–æ–¥—É–∫—Ç—ñ–≤" value="{{ request.GET.q }}">
    </div>
    <div class="col-md-3">
      <select name="category" class="form-control">
        <option value="">–í—Å—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option>
        {% for cat in categories %}
          <option value="{{ cat.id }}" {% if request.GET.category == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <select name="sort_by" class="form-control">
        <option value="name" {% if request.GET.sort_by == "name" %}selected{% endif %}>–°–æ—Ä—Ç—É–≤–∞—Ç–∏ –∑–∞ –Ω–∞–∑–≤–æ—é</option>
        <option value="price" {% if request.GET.sort_by == "price" %}selected{% endif %}>–°–æ—Ä—Ç—É–≤–∞—Ç–∏ –∑–∞ —Ü—ñ–Ω–æ—é</option>
        <option value="quantity" {% if request.GET.sort_by == "quantity" %}selected{% endif %}>–°–æ—Ä—Ç—É–≤–∞—Ç–∏ –∑–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—é</option>
      </select>
    </div>
    <div class="col-md-2">
      <button class="btn btn-primary w-100" type="submit">üîç –§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏</button>
    </div>
  </div>
</form>

<!-- –í–∏–±—ñ—Ä –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ç–æ–≤–∞—Ä—ñ–≤ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ -->
<div class="mb-3">
  <label for="itemsPerPage">–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ–≤–∞—Ä—ñ–≤:</label>
  <select id="itemsPerPage" name="items_per_page" class="form-select w-auto d-inline">
    <option value="10" {% if items_per_page == "10" %}selected{% endif %}>10</option>
    <option value="20" {% if items_per_page == "20" %}selected{% endif %}>20</option>
    <option value="50" {% if items_per_page == "50" %}selected{% endif %}>50</option>
    <option value="100" {% if items_per_page == "100" %}selected{% endif %}>100</option>
  </select>
</div>

<div class="mb-3">
  <a href="{% url 'product-create' %}" class="btn btn-success">
    <i class="fas fa-plus"></i> –î–æ–¥–∞—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç
  </a>
  <button class="btn btn-secondary" onclick="location.reload();">
    <i class="fas fa-sync"></i> –û–Ω–æ–≤–∏—Ç–∏
  </button>
  <a href="{% url 'export-products' %}" class="btn btn-outline-primary ms-2">
    <i class="fas fa-file-download"></i> –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—Å—ñ –ø—Ä–æ–¥—É–∫—Ç–∏ (CSV)
  </a>
  <a href="{% url 'export-out-of-stock' %}" class="btn btn-outline-danger ms-2">
    <i class="fas fa-exclamation-circle"></i> –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ç–æ–≤–∞—Ä–∏ –±–µ–∑ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ (CSV)
  </a>
</div>

<div id="productsTableContainer">
  <table class="table table-hover table-bordered">
    <thead class="table-dark">
      <tr>
        <th>–ù–∞–∑–≤–∞</th>
        <th>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</th>
        <th>–¶—ñ–Ω–∞</th>
        <th>–ó–Ω–∏–∂–∫–∞</th>
        <th>–ö—ñ–Ω—Ü–µ–≤–∞ —Ü—ñ–Ω–∞</th>
        <th>–ù–∞—è–≤–Ω—ñ—Å—Ç—å</th>
        <th>–î—ñ—ó</th>
      </tr>
    </thead>
    <tbody>
      {% for product in products %}
      <tr>
        <td>{{ product.name }}</td>
        <td>{{ product.category.name }}</td>
        <td>${{ product.price }}</td>
        <td>{{ product.discount }}%</td>
        <td>${{ product.final_price }}</td>
        <td>
          {% if product.in_stock %}
            <span class="badge bg-success">‚úî –í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</span>
          {% else %}
            <span class="badge bg-danger">‚ùå –ù–µ–º–∞—î</span>
          {% endif %}
        </td>
        <td class="text-center">
          <div class="d-flex justify-content-center gap-2">
            <a href="{% url 'product-detail' product.pk %}" class="btn btn-info btn-sm px-3" title="–ü–µ—Ä–µ–≥–ª—è–¥">
              <i class="fas fa-eye"></i> –ü–µ—Ä–µ–≥–ª—è–¥
            </a>
            <a href="{% url 'product-update' product.pk %}" class="btn btn-warning btn-sm px-3" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">
              <i class="fas fa-edit"></i> –†–µ–¥–∞–≥—É–≤–∞—Ç–∏
            </a>
            <a href="{% url 'product-delete' product.pk %}" class="btn btn-danger btn-sm px-3" title="–í–∏–¥–∞–ª–∏—Ç–∏">
              <i class="fas fa-trash-alt"></i> –í–∏–¥–∞–ª–∏—Ç–∏
            </a>
          </div>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="7" class="text-center">–ù–µ–º–∞—î –ø—Ä–æ–¥—É–∫—Ç—ñ–≤</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è -->
<nav>
  <ul class="pagination justify-content-center">
    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page=1&items_per_page={{ items_per_page }}">‚è™ –ü–µ—Ä—à–∞</a>
      </li>
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.previous_page_number }}&items_per_page={{ items_per_page }}">‚¨Ö –ü–æ–ø–µ—Ä–µ–¥–Ω—è</a>
      </li>
    {% endif %}
    {% for num in paginator.page_range %}
      <li class="page-item {% if page_obj.number == num %}active{% endif %}">
        <a class="page-link" href="?page={{ num }}&items_per_page={{ items_per_page }}">{{ num }}</a>
      </li>
    {% endfor %}
    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.next_page_number }}&items_per_page={{ items_per_page }}">‚û° –ù–∞—Å—Ç—É–ø–Ω–∞</a>
      </li>
      <li class="page-item">
        <a class="page-link" href="?page={{ paginator.num_pages }}&items_per_page={{ items_per_page }}">‚è© –û—Å—Ç–∞–Ω–Ω—è</a>
      </li>
    {% endif %}
  </ul>
</nav>
{% endblock %}

{% block extra_js %}
<script>
  document.getElementById("itemsPerPage").addEventListener("change", function() {
    window.location.href = "?items_per_page=" + this.value;
  });
</script>
{% endblock %}
